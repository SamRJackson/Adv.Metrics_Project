---
title: "R Notebook"
output: html_notebook
---

# Packages.
_uncomment the first line if the chunk doesn't run_
```{r}
#install.packages("leaps")
#install.packages("ggplot2")
#install.packages("dplyr")
#install.packages("stargazer") #To get summary stat on Latex
#install.packags("mgcv") #To run the Gam 
library(stargazer)
library(readxl)
library(dplyr)
library(ggplot2)
library(leaps)
library(mgcv)
```

# Loading in the dataset.
```{r}
load("/Users/mathis/SFR Cloud/AMSE/Master 2 -ETE-/Advanced_econometrics/Project/dataCrime.RData")
```

# Variable of interest selection.
We start by keeping a wide selection of potential explanatory variables. Choice of variables was based on model specifications in the existing literature around crime. 
```{r}
variables_chosen <- c("communityname","state","population","PopDens","householdsize","PctFam2Par","racepctblack","racePctHisp","agePct16t24","perCapInc","pctWSocSec","pctWInvInc","PctPopUnderPov","PctNotHSGrad","PctUnemployed","ViolentCrimesPerPop","nonViolPerPop")
colnames(concat_test)<-gsub(":","",colnames(concat_test))# remove semicolons from names
concat_dropped <- concat_test[variables_chosen]
```

# Cleaning the datatset
```{r}
is.data.frame(concat_dropped)#test dataframe ok
i=c(3:17) #Select variables to turn into numeric
concat_dropped[ , i] <- apply(concat_dropped[ , i], 2,
                    function(x) as.numeric(as.character(x)))#convert relevant variables in numeric
sapply(concat_dropped, class) #check ok
concat_dropped$crimes=concat_dropped$ViolentCrimesPerPop + concat_dropped$nonViolPerPop #create dependent variable
concat_wo_na= na.omit(concat_dropped)#Drop NA statistics on drops
```

# Using subset selection and Bayesian Information Criteria to select variables
```{r}
drops <- c("communityname", "state", "nonViolPerPop","ViolentCrimesPerPop")
subselect_sample <- select(concat_wo_na,-all_of(drops))
subselect_res <- regsubsets(crimes~., data = subselect_sample, nvmax = 9, method = "forward")

summary(subselect_res)
subselect_sums <- summary(subselect_res)
data.frame(
  Adj.R2 = which.max(subselect_sums$adjr2),
  CP = which.min(subselect_sums$cp),
  BIC = which.min(subselect_sums$bic)
)
```

# Defining the final dataset we will use for estimation
```{r}
final_variables= c("communityname","state","PopDens","householdsize","PctFam2Par","racepctblack","racePctHisp","agePct16t24","PctPopUnderPov","PctNotHSGrad","PctUnemployed","crimes")
dataset=concat_wo_na[final_variables]
is.data.frame(dataset)#test dataframe ok
```
# Summary Statistics
```{r}
stargazer(as.data.frame(dataset))
```


# Gam Model 

Here is the raw version of the Gam model
```{r}
attach(dataset)

Gam <- gam((crimes~s(PopDens)+s(householdsize)+s(PctFam2Par)+s(racepctblack)+s(racePctHisp)+s(agePct16t24)+s(PctPopUnderPov)+s(PctNotHSGrad)+s(PctUnemployed))) 

summary(Gam)
```

Now we can analyze the graphs 

```{r}
plot(Gam, select=1, shade=T, shade.col="lightblue", rug=T, ylim=c(-5000,1000))
```

```{r}
plot(Gam, select=2, shade=T, shade.col="lightblue", rug=T, ylim=c(-1000,7000))
```

```{r}
plot(Gam, select=3, shade=T, shade.col="lightblue", rug=T, ylim=c(-2000,15000))
```

```{r}
plot(Gam, select=4, shade=T, shade.col="lightblue", rug=T, ylim=c(-2000,2000))
```

```{r}
plot(Gam, select=5, shade=T, shade.col="lightblue", rug=T, ylim=c(-2000,8000))
```

```{r}
plot(Gam, select=6, shade=T, shade.col="lightblue", rug=T, ylim=c(-2000,2000))
```

```{r}
plot(Gam, select=7, shade=T, shade.col="lightblue", rug=T, ylim=c(-2000,2000) )
```

```{r}
plot(Gam, select=8, shade=T, shade.col="lightblue", rug=T, ylim=c(-2000,2000))
```

```{r}
plot(Gam, select=9, shade=T, shade.col="lightblue", rug=T, ylim=c(-5000,500))
```






